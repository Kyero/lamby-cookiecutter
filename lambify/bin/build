#!/usr/bin/env bash
set -e

if [ -z ${RAILS_ENV+x} ]; then
  echo "Missing RAILS_ENV env variable!"
  exit 126
fi

echo "== SAM build =="
rm -rf ./.bundle ./vendor/bundle
sam build

echo "== Environments & Configuration =="
pushd ./.aws-sam/build/{% include "_cctmp/class_name.txt" %}Lambda/
RAILS_MASTER_KEY=$(aws ssm get-parameter \
  --name "/{% include "_cctmp/file_name.txt" %}/RAILS_MASTER_KEY" \
  --with-decryption \
  --query "Parameter.Value" \
  --output text 2> /dev/null | echo "$(</dev/stdin)"
)
echo "RAILS_MASTER_KEY=$RAILS_MASTER_KEY" > ".env.$RAILS_ENV"
popd

echo "== Asset Hosts & Precompiling =="
pushd ./.aws-sam/build/{% include "_cctmp/class_name.txt" %}Lambda/
NODE_ENV='production' \
  RAILS_GROUPS=assets \
  LAMBY_BUILD=1 \
  ./bin/rails assets:precompile
rm -rf ./app/assets/images \
       ./app/assets/javascripts \
       ./app/assets/stylesheets \
       ./app/javascript \
       ./vendor/assets
popd

echo "== Clean un-needed artifacts =="
pushd ./.aws-sam/build/{% include "_cctmp/class_name.txt" %}Lambda/
rm -rf \
  .browserslistrc \
  .bucket-name \
  .github \
  .gitignore \
  .env.development \
  .env.test \
  config/master.key \
  docker-compose.yml \
  Dockerfile \
  babel.config.js \
  README.md \
  log \
  package.json \
  postcss.config.js \
  node_modules \
  template.yaml \
  test \
  tmp \
  yarn.lock
pushd ./vendor/bundle/ruby/2.7.0
rm -rf \
  ./cache \
  ./extensions/websocket-driver-* \
  ./gems/nokogiri*/ext \
  ./gems/mail-* \
  ./gems/nio4r-* \
  ./gems/activerecord-* \
  ./gems/websocket-driver-* \
  ./gems/rb-fsevent-* \
  ./gems/actioncable-* \
  ./gems/arel-* \
  ./gems/execjs-* \
  ./gems/rails-dom-testing-* \
  ./gems/rb-inotify-* \
  ./gems/websocket-extensions-* \
  ./gems/sass* \
  ./gems/uglifier-*
popd
popd
